<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Isekai Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md shadow-md z-20 sticky top-0">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
             <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold text-slate-800">Japanese Isekai Adventure</h1>
                <button id="settings-button" class="p-2 rounded-full hover:bg-slate-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
             </div>
        </div>
    </header>

    <!-- Chat Container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8">
        <div id="message-list" class="max-w-6xl mx-auto space-y-6">
            <!-- All messages dynamically inserted here -->
            {% for msg in messages %}
                {% if msg.role == 'model' %}
                    <div class="message-turn">
                        <p class="font-semibold text-slate-600 text-sm ml-12 mb-1">{{ character_name }}</p>
                        <div class="flex items-start gap-3">
                            <div class="avatar-companion">A</div>
                            <div class="bubble bubble-companion flex-1">
                                {% for part in msg.parsed_content %}
                                    <p class="japanese-text">{{ part.japanese | safe }}</p>
                                    {% if part.english %}<p class="english-translation text-sm text-gray-600">{{ part.english }}</p>{% endif %}
                                {% endfor %}
                                {% if msg.parsed_content[0].has_japanese %} {# Check the new has_japanese flag #}
                                    <div class="speech-icon" onclick="toggleSpeech(this)">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% elif msg.role == 'user' %}
                    <div class="message-turn">
                        <p class="font-semibold text-slate-600 text-sm text-right mr-12 mb-1">{{ user_name }}</p>
                        <div class="flex items-start gap-3 justify-end">
                            <div class="bubble bubble-user max-w-4xl">
                                <p class="user-text">{{ msg.parsed_content[0].japanese }}</p>
                            </div>
                            <div class="avatar-user">Y</div>
                        </div>
                    </div>
                {# Removed the 'system' role display here #}
                {% endif %}
            {% endfor %}

            <div id="typing-indicator" class="hidden message-turn">
                 <p class="font-semibold text-slate-600 text-sm ml-12 mb-1">{{ character_name }}</p>
                 <div class="flex items-start gap-3">
                    <div class="avatar-companion">A</div>
                    <div class="bubble bubble-companion">
                        <div class="typing-dots"><span></span><span></span><span></span></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Settings Panel -->
    <div id="settings-overlay" class="fixed inset-0 bg-black/60 z-30 hidden"></div>
    <div id="settings-panel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-40 transform translate-x-full transition-transform">
        <div class="flex flex-col h-full">
            <!-- Panel Header -->
            <div class="flex items-center justify-between p-4 border-b">
                <h2 class="text-lg font-bold">Guidebook & Settings</h2>
                <button id="close-settings-button" class="p-2 rounded-full hover:bg-slate-200 text-2xl leading-none">&times;</button>
            </div>
            <!-- Tab Navigation -->
            <div class="border-b">
                <nav class="flex -mb-px">
                    <button data-tab="display" class="tab-button active">Display</button>
                    <button data-tab="journal" class="tab-button">Journal</button>
                    <button data-tab="vocab" class="tab-button">Vocabulary</button>
                </nav>
            </div>
            <!-- Tab Content -->
            <div class="flex-grow p-4 overflow-y-auto">
                <!-- Display Tab -->
                <div id="tab-display" class="tab-content active">
                    <h3 class="setting-title">Theme</h3>
                    <div class="setting-item">
                        <label>Color Mode</label>
                        <div class="flex gap-2" id="theme-switcher">
                            <button data-theme="light" class="theme-button active">Light</button>
                            <button data-theme="dark" class="theme-button">Dark</button>
                        </div>
                    </div>
                     <div class="setting-item">
                        <label>Bubble Style</label>
                        <div class="flex gap-2" id="bubble-style-switcher">
                            <button data-style="rounded" class="theme-button active">Rounded</button>
                            <button data-style="sharp" class="theme-button">Sharp</button>
                        </div>
                    </div>

                    <h3 class="setting-title">Companion Styles</h3>
                    <div class="setting-item">
                        <label>Avatar & Icon Color</label>
                        <input type="color" data-css-var="--companion-avatar-bg">
                    </div>
                     <div class="setting-item">
                        <label>Bubble Background</label>
                        <input type="color" data-css-var="--companion-bubble-bg">
                    </div>
                    <div class="setting-item">
                        <label>Japanese Font Size</label>
                        <input type="range" min="14" max="28" step="1" data-css-var="--companion-jp-font-size" data-unit="px">
                    </div>

                    <h3 class="setting-title">Your Styles</h3>
                    <div class="setting-item">
                        <label>Bubble Color</label>
                        <input type="color" data-css-var="--user-bubble-bg">
                    </div>
                    <div class="setting-item">
                        <label>Your Font Size</label>
                        <input type="range" min="12" max="24" step="1" data-css-var="--user-font-size" data-unit="px">
                    </div>
                </div>
                <!-- Journal Tab -->
                <div id="tab-journal" class="tab-content hidden">
                    <textarea id="journal-notes" class="w-full h-full p-2 border rounded-md resize-none" placeholder="Your private notes about the adventure..."></textarea>
                </div>
                <!-- Vocabulary Tab -->
                <div id="tab-vocab" class="tab-content hidden">
                    <p class="text-sm text-slate-500 mb-2">Click a word with furigana in the chat to save it here.</p>
                    <ul id="vocab-list" class="space-y-2"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Input Form -->
    <footer class="bg-white/80 backdrop-blur-md border-t border-slate-200 p-4 sticky bottom-0 z-10">
         <div class="max-w-6xl mx-auto">
            <form id="message-form" class="flex items-center gap-3">
                <input type="text" id="message-input" placeholder="Type your response..." autocomplete="off">
                <button type="submit" id="send-button">Send</button>
            </form>
        </div>
    </footer>

    <script type="application/json" id="flask-messages-data">
        {{ messages | tojson }}
    </script>
    <script>
        const characterName = "{{ character_name }}";
        const userName = "{{ user_name }}";
    </script>
    <script src="{{ url_for('static', filename='js/functions.js') }}"></script>
</body>
</html>
